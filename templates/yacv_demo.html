<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YACV Build123d Demo - Morfis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        .demo-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .demo-header {
            background: #f8f9fa;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .demo-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .code-panel {
            width: 40%;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }

        .viewer-panel {
            width: 60%;
            display: flex;
            flex-direction: column;
        }

        .code-editor {
            flex: 1;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            border: none;
            resize: none;
            padding: 1rem;
            outline: none;
            background: #f8f9fa;
        }

        .code-controls {
            padding: 0.75rem 1rem;
            background: #e9ecef;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .viewer-container {
            flex: 1;
            background: #fff;
        }

        .example-btn {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-ready {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-processing {
            background: #cce5ff;
            color: #004085;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>

<body>
    <div class="demo-container">
        <!-- Header -->
        <div class="demo-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-1">YACV Build123d Demo</h4>
                    <small class="text-muted">Interactive CAD modeling with Build123d and Yet Another CAD Viewer</small>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <span id="statusBadge" class="status-badge status-ready">Ready</span>
                    <a href="/" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> Back to Morfis
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="demo-content">
            <!-- Code Panel -->
            <div class="code-panel">
                <div class="p-3 bg-light border-bottom">
                    <h6 class="mb-2">Build123d Code Editor</h6>
                    <div class="d-flex gap-1 flex-wrap">
                        <button class="btn btn-outline-primary example-btn" onclick="loadExample('box_with_hole')">
                            Box with Hole
                        </button>
                        <button class="btn btn-outline-primary example-btn" onclick="loadExample('simple_bracket')">
                            Bracket
                        </button>
                        <button class="btn btn-outline-primary example-btn" onclick="loadExample('gear')">
                            Gear
                        </button>
                    </div>
                </div>

                <textarea id="codeEditor" class="code-editor" placeholder="Enter your Build123d code here...">
# Build123d Example: Box with Hole
from build123d import *

# Create a simple box with a cylindrical hole
with BuildPart() as example:
    Box(10, 10, 5)  # 10x10x5 box
    Cylinder(2, 5, mode=Mode.SUBTRACT)  # Subtract a cylinder (hole)

# Set color for the part
example.color = (0.2, 0.6, 0.8, 1.0)  # Blue color (RGBA)

# Show the part in YACV viewer
from yacv_server import show
show(example)
                </textarea>

                <div class="code-controls">
                    <button id="executeBtn" class="btn btn-primary" onclick="executeCode()">
                        <i class="fas fa-play"></i> Execute
                    </button>
                    <button id="clearBtn" class="btn btn-outline-secondary" onclick="clearViewer()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                    <button id="testConnectionBtn" class="btn btn-outline-info" onclick="testYACVConnection()">
                        <i class="fas fa-external-link-alt"></i> Open in New Window
                    </button>
                    <div class="ms-auto">
                        <small class="text-muted">Press Ctrl+Enter to execute</small>
                    </div>
                </div>
            </div>

            <!-- Viewer Panel -->
            <div class="viewer-panel">
                <div class="p-3 bg-light border-bottom">
                    <h6 class="mb-0">3D CAD Viewer</h6>
                    <small class="text-muted">Powered by Yet Another CAD Viewer (YACV)</small>
                </div>

                <div id="viewerContainer" class="viewer-container">
                    <!-- YACV viewer will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/yacv_build123d_viewer.js"></script>

    <script>
        let viewer = null;

        // Initialize viewer when page loads
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                const container = document.getElementById('viewerContainer');
                viewer = new YACVBuild123dViewer();
                await viewer.init(container);
                console.log('✅ YACV Build123d viewer initialized');
            } catch (error) {
                console.error('❌ Failed to initialize viewer:', error);
                updateStatus('Viewer initialization failed', 'error');
            }
        });

        // Execute code function
        async function executeCode() {
            if (!viewer) {
                updateStatus('Viewer not initialized', 'error');
                return;
            }

            const code = document.getElementById('codeEditor').value.trim();
            if (!code) {
                updateStatus('No code to execute', 'error');
                return;
            }

            const executeBtn = document.getElementById('executeBtn');
            const originalContent = executeBtn.innerHTML;

            try {
                // Update UI to show execution in progress
                executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executing...';
                executeBtn.disabled = true;
                updateStatus('Executing Build123d code...', 'processing');

                // Execute the code
                const result = await viewer.executeBuild123dCode(code);
                if (result && result.server_url) {
                    lastServerUrl = result.server_url;
                }
                updateStatus('Code executed successfully', 'success');

            } catch (error) {
                console.error('❌ Execution failed:', error);
                updateStatus(`Execution failed: ${error.message}`, 'error');
            } finally {
                // Restore button
                executeBtn.innerHTML = originalContent;
                executeBtn.disabled = false;
            }
        }

        // Clear viewer function
        function clearViewer() {
            if (viewer) {
                viewer.clearModel();
                updateStatus('Viewer cleared', 'ready');
                document.getElementById('testConnectionBtn').style.display = 'none';
            }
        }

        // Store the last server URL globally
        let lastServerUrl = null;

        // Test YACV connection function
        function testYACVConnection() {
            if (lastServerUrl) {
                const newWindow = window.open(lastServerUrl + '/index.html', 'yacv_viewer', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                if (newWindow) {
                    updateStatus('YACV viewer opened in new window', 'success');
                } else {
                    updateStatus('Failed to open viewer - check popup blocker', 'error');
                }
            } else {
                updateStatus('No active YACV server - execute code first', 'error');
            }
        }

        // Load example function
        async function loadExample(exampleName) {
            if (!viewer) {
                updateStatus('Viewer not initialized', 'error');
                return;
            }

            try {
                updateStatus('Loading example...', 'processing');
                await viewer.loadExample(exampleName);
                updateStatus('Example loaded successfully', 'success');
            } catch (error) {
                console.error('❌ Failed to load example:', error);
                updateStatus(`Failed to load example: ${error.message}`, 'error');
            }
        }

        // Update status function
        function updateStatus(message, type) {
            const badge = document.getElementById('statusBadge');
            badge.textContent = message;
            badge.className = `status-badge status-${type}`;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                executeCode();
            }
        });

        // Auto-resize textarea
        const codeEditor = document.getElementById('codeEditor');
        codeEditor.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    </script>
</body>

</html>